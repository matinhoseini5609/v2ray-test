import requests
import hashlib
import time
import datetime
import json
import os

BOT_TOKEN = "7466526823:AAFBMdxP9kGUBrKDthvlZR26zcTcMVKG6bI"
ADMIN_ID = "7172173925"

telegram_api_url = f"https://api.telegram.org/bot{BOT_TOKEN}"

USERS_FILE = "users.json"
SOURCES_FILE = "sources.json"
LOG_FILE = "messages_log.json"


# --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ ---
def load_json(filename):
    if os.path.exists(filename):
        with open(filename, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}


def save_json(filename, data):
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


users = load_json(
    USERS_FILE)  # { chat_id: {"last_active": timestamp, "name": username} }
messages_log = load_json(LOG_FILE)  # list of {chat_id, name, text, time}
sources = load_json(SOURCES_FILE)

if not sources:
    sources = {
        "Barry - VLess": {
            "url":
            "https://raw.githubusercontent.com/barry-far/V2ray-config/main/Splitted-By-Protocol/vless.txt",
            "repo": "barry-far/V2ray-config",
            "path": "Splitted-By-Protocol/vless.txt"
        },
        "Barry - Sub1": {
            "url":
            "https://raw.githubusercontent.com/barry-far/V2ray-config/main/Sub1.txt",
            "repo": "barry-far/V2ray-config",
            "path": "Sub1.txt"
        },
        "EbraSha": {
            "url":
            "https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/V2Ray-Config-By-EbraSha.txt",
            "repo": "ebrasha/free-v2ray-public-list",
            "path": "V2Ray-Config-By-EbraSha.txt"
        },
        "Epodonios - VLess": {
            "url":
            "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/Splitted-By-Protocol/vless.txt",
            "repo": "Epodonios/v2ray-configs",
            "path": "Splitted-By-Protocol/vless.txt"
        },
        "Epodonios - Sub1": {
            "url":
            "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/Sub1.txt",
            "repo": "Epodonios/v2ray-configs",
            "path": "Sub1.txt"
        },
        "Test File": {
            "url":
            "https://raw.githubusercontent.com/matinhoseini5609/v2ray-test/main/test.txt",
            "repo": "matinhoseini5609/v2ray-test",
            "path": "test.txt"
        }
    }
    save_json(SOURCES_FILE, sources)

last_hashes = {}
cache_commit_times = {}


def send_telegram_message(chat_id, text, reply_markup=None):
    url = f"{telegram_api_url}/sendMessage"
    data = {"chat_id": chat_id, "text": text}
    if reply_markup:
        data["reply_markup"] = json.dumps(reply_markup)
    try:
        response = requests.post(url, data=data)
        if response.status_code != 200:
            print(
                f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: {response.status_code} - {response.text}"
            )
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: {e}")


def edit_telegram_message(chat_id, message_id, text, reply_markup=None):
    url = f"{telegram_api_url}/editMessageText"
    data = {
        "chat_id": chat_id,
        "message_id": message_id,
        "text": text,
    }
    if reply_markup:
        data["reply_markup"] = json.dumps(reply_markup)
    try:
        response = requests.post(url, data=data)
        if response.status_code != 200:
            print(
                f"âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…: {response.status_code} - {response.text}"
            )
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…: {e}")


def load_users():
    global users
    users = load_json(USERS_FILE)


def save_users():
    save_json(USERS_FILE, users)


def load_logs():
    global messages_log
    messages_log = load_json(LOG_FILE)


def save_logs():
    save_json(LOG_FILE, messages_log)


def load_sources():
    global sources
    sources = load_json(SOURCES_FILE)


def save_sources():
    save_json(SOURCES_FILE, sources)


def add_user(chat_id, name):
    users[str(chat_id)] = {
        "last_active": int(time.time()),
        "name": name or "Ù†Ø§Ø´Ù†Ø§Ø³"
    }
    save_users()


def update_user_activity(chat_id):
    uid = str(chat_id)
    if uid in users:
        users[uid]["last_active"] = int(time.time())
        save_users()


def log_message(chat_id, name, text):
    messages_log.append({
        "chat_id": chat_id,
        "name": name or "Ù†Ø§Ø´Ù†Ø§Ø³",
        "text": text,
        "time": int(time.time())
    })
    if len(messages_log) > 100:
        messages_log.pop(0)
    save_logs()


def check_sources():
    global last_hashes
    for name, info in sources.items():
        try:
            response = requests.get(info["url"], timeout=15)
            if response.status_code == 200:
                content = response.text.strip()
                content_hash = hashlib.sha256(content.encode()).hexdigest()
                if name not in last_hashes:
                    last_hashes[name] = content_hash
                elif last_hashes[name] != content_hash:
                    last_hashes[name] = content_hash
                    message = f"ğŸ“¢ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯ÛŒØ¯ Ù…Ù†ØªØ´Ø± Ø´Ø¯!\nğŸ“„ Ù…Ù†Ø¨Ø¹: {name}\nğŸ”— Ù„ÛŒÙ†Ú©: {info['url']}"
                    for uid in users.keys():
                        send_telegram_message(uid, message)
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ {name}: {e}")


def format_time_difference(ts):
    if not ts:
        return "â›” Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù†"
    now = int(time.time())
    diff = now - ts
    if diff < 60:
        return "Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†"
    elif diff < 3600:
        return f"{diff//60} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´"
    elif diff < 86400:
        return f"{diff//3600} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´"
    else:
        return datetime.datetime.fromtimestamp(ts).strftime("%Y-%m-%d %H:%M")


def get_last_commit_time(repo, path):
    key = f"{repo}/{path}"
    now = time.time()
    if key in cache_commit_times:
        cache_time, cached_dt = cache_commit_times[key]
        if now - cache_time < 300:
            return cached_dt

    url = f"https://api.github.com/repos/{repo}/commits"
    params = {"path": path, "per_page": 1}
    try:
        response = requests.get(url, params=params, timeout=10)
        if response.status_code == 200:
            commit_data = response.json()
            if commit_data:
                commit_time = commit_data[0]["commit"]["author"]["date"]
                dt = datetime.datetime.strptime(commit_time,
                                                "%Y-%m-%dT%H:%M:%SZ")
                cache_commit_times[key] = (now, dt)
                return dt
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù† commit Ø¨Ø±Ø§ÛŒ {repo}/{path}: {e}")
    return None


def handle_updates_command(chat_id):
    message = "ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨:\n\n"
    for name, info in sources.items():
        last_commit = get_last_commit_time(info["repo"], info["path"])
        ts = int(last_commit.timestamp()) if last_commit else None
        message += f"ğŸ“Œ {name}: {format_time_difference(ts)}\n"
    send_telegram_message(chat_id, message)


def send_subscription_links(chat_id):
    message = "ğŸŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯:\n\n"
    for name, info in sources.items():
        message += f"ğŸ”— {name}:\n{info['url']}\n\n"
    send_telegram_message(chat_id, message)


def broadcast_to_all(message):
    for uid in users.keys():
        send_telegram_message(uid, f"ğŸ“¢ Ù¾ÛŒØ§Ù… Ù…Ø¯ÛŒØ±:\n\n{message}")


def list_users(chat_id):
    lines = [f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {len(users)}\n\n"]
    now = int(time.time())
    for uid, info in users.items():
        last_active = format_time_difference(info.get("last_active"))
        name = info.get("name", "Ù†Ø§Ø´Ù†Ø§Ø³")
        lines.append(f"- {name} (id: {uid}): Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª {last_active}")
    send_telegram_message(chat_id, "\n".join(lines))


def list_logs(chat_id):
    lines = []
    for log in reversed(messages_log[-20:]):
        t = datetime.datetime.fromtimestamp(
            log["time"]).strftime("%Y-%m-%d %H:%M:%S")
        lines.append(
            f"{t} | {log['name']} (id:{log['chat_id']}): {log['text']}")
    if not lines:
        lines = ["Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø¯Ø± Ù„Ø§Ú¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."]
    send_telegram_message(chat_id, "ğŸ“œ Û²Û° Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±:\n\n" + "\n".join(lines))


def show_last_activity(chat_id):
    lines = [f"ğŸ‘¤ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\n"]
    now = int(time.time())
    for uid, info in users.items():
        last_active = format_time_difference(info.get("last_active"))
        name = info.get("name", "Ù†Ø§Ø´Ù†Ø§Ø³")
        lines.append(f"- {name} (id: {uid}): {last_active}")
    send_telegram_message(chat_id, "\n".join(lines))


# Admin Panel Inline Keyboard Buttons
def admin_panel_keyboard():
    keyboard = {
        "inline_keyboard": [[{
            "text": "ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù†Ø§Ø¨Ø¹",
            "callback_data": "check_sources"
        }, {
            "text": "ğŸ—‚ Ù…Ù†Ø§Ø¨Ø¹ ÙØ¹Ù„ÛŒ",
            "callback_data": "show_sources"
        }],
                            [{
                                "text": "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",
                                "callback_data": "count_users"
                            }, {
                                "text": "ğŸ‘¤ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",
                                "callback_data": "last_activity_users"
                            }],
                            [{
                                "text": "ğŸ‘¥ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ",
                                "callback_data": "broadcast_start"
                            }, {
                                "text": "ğŸ“œ Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§",
                                "callback_data": "show_logs"
                            }],
                            [{
                                "text": "â• Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯",
                                "callback_data": "add_link"
                            }, {
                                "text": "âŒ Ø­Ø°Ù Ù„ÛŒÙ†Ú©",
                                "callback_data": "delete_link"
                            }],
                            [{
                                "text": "ğŸ›‘ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾Ù†Ù„",
                                "callback_data": "exit_panel"
                            }]]
    }
    return keyboard


admin_state = {
    "mode": None,
    "broadcast_message": None,
    "add_link_name": None,
    "delete_link_name": None,
    "panel_message_id": None,
}


def handle_callback_query(update):
    callback = update.get("callback_query")
    if not callback:
        return

    chat_id = callback["message"]["chat"]["id"]
    message_id = callback["message"]["message_id"]
    data = callback["data"]

    # ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø±Ù‡
    if str(chat_id) != ADMIN_ID:
        send_telegram_message(chat_id,
                              "â›”ï¸ Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return

    # ÙˆØ§Ú©Ù†Ø´ Ø¨Ù‡ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    if data == "check_sources":
        check_sources()
        edit_telegram_message(chat_id,
                              message_id,
                              "ğŸ”„ Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù†Ø¯.",
                              reply_markup=admin_panel_keyboard())
    elif data == "show_sources":
        msg = "ğŸŒ Ù…Ù†Ø§Ø¨Ø¹ ÙØ¹Ù„ÛŒ:\n\n"
        for name, info in sources.items():
            msg += f"ğŸ”— {name}:\n{info['url']}\n\n"
        edit_telegram_message(chat_id,
                              message_id,
                              msg,
                              reply_markup=admin_panel_keyboard())
    elif data == "count_users":
        edit_telegram_message(chat_id,
                              message_id,
                              f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: {len(users)}",
                              reply_markup=admin_panel_keyboard())
    elif data == "last_activity_users":
        lines = []
        for uid, info in users.items():
            last_active = format_time_difference(info.get("last_active"))
            name = info.get("name", "Ù†Ø§Ø´Ù†Ø§Ø³")
            lines.append(f"- {name} (id: {uid}): {last_active}")
        edit_telegram_message(chat_id,
                              message_id,
                              "ğŸ‘¤ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\n" + "\n".join(lines),
                              reply_markup=admin_panel_keyboard())
    elif data == "broadcast_start":
        admin_state["mode"] = "broadcast_wait_message"
        admin_state["panel_message_id"] = message_id
        edit_telegram_message(
            chat_id,
            message_id,
            "âœï¸ Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯...\n(Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯)",
            reply_markup=None)
    elif data == "show_logs":
        lines = []
        for log in reversed(messages_log[-20:]):
            t = datetime.datetime.fromtimestamp(
                log["time"]).strftime("%Y-%m-%d %H:%M:%S")
            lines.append(
                f"{t} | {log['name']} (id:{log['chat_id']}): {log['text']}")
        if not lines:
            lines = ["Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø¯Ø± Ù„Ø§Ú¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."]
        edit_telegram_message(chat_id,
                              message_id,
                              "ğŸ“œ Û²Û° Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±:\n\n" + "\n".join(lines),
                              reply_markup=admin_panel_keyboard())
    elif data == "add_link":
        admin_state["mode"] = "add_link_wait_name"
        admin_state["panel_message_id"] = message_id
        edit_telegram_message(chat_id,
                              message_id,
                              "Ù†Ø§Ù… Ù…Ù†Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
                              reply_markup=None)
    elif data == "delete_link":
        admin_state["mode"] = "delete_link_wait_name"
        admin_state["panel_message_id"] = message_id
        edit_telegram_message(chat_id,
                              message_id,
                              "Ù†Ø§Ù… Ù…Ù†Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
                              reply_markup=None)
    elif data == "exit_panel":
        admin_state["mode"] = None
        admin_state["panel_message_id"] = None
        edit_telegram_message(chat_id,
                              message_id,
                              "âœ… Ø§Ø² Ù¾Ù†Ù„ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.",
                              reply_markup=None)


def process_admin_text(chat_id, text):
    mode = admin_state.get("mode")
    if str(chat_id) != ADMIN_ID:
        return False

    if mode == "broadcast_wait_message":
        broadcast_to_all(text)
        send_telegram_message(chat_id, "âœ… Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        admin_state["mode"] = None
        # Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ Ù¾Ù†Ù„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        if admin_state.get("panel_message_id"):
            send_telegram_message(chat_id,
                                  "ğŸ› Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:",
                                  reply_markup=admin_panel_keyboard())
        return True

    elif mode == "add_link_wait_name":
        admin_state["add_link_name"] = text.strip()
        admin_state["mode"] = "add_link_wait_url"
        send_telegram_message(chat_id, "Ù„Ø·ÙØ§ Ù„ÛŒÙ†Ú© Ù…Ù†Ø¨Ø¹ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        return True

    elif mode == "add_link_wait_url":
        url = text.strip()
        name = admin_state.get("add_link_name")
        if not name or not url:
            send_telegram_message(chat_id,
                                  "Ù†Ø§Ù… ÛŒØ§ Ù„ÛŒÙ†Ú© Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        else:
            sources[name] = {"url": url, "repo": "", "path": ""}
            save_sources()
            send_telegram_message(chat_id,
                                  f"âœ… Ù…Ù†Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù†Ø§Ù… '{name}' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
        admin_state["mode"] = None
        admin_state["add_link_name"] = None
        # Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ Ù¾Ù†Ù„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        send_telegram_message(chat_id,
                              "ğŸ› Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:",
                              reply_markup=admin_panel_keyboard())
        return True

    elif mode == "delete_link_wait_name":
        name = text.strip()
        if name in sources:
            del sources[name]
            save_sources()
            send_telegram_message(chat_id, f"âœ… Ù…Ù†Ø¨Ø¹ '{name}' Ø­Ø°Ù Ø´Ø¯.")
        else:
            send_telegram_message(chat_id, f"âŒ Ù…Ù†Ø¨Ø¹ '{name}' Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
        admin_state["mode"] = None
        # Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ Ù¾Ù†Ù„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        send_telegram_message(chat_id,
                              "ğŸ› Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:",
                              reply_markup=admin_panel_keyboard())
        return True

    return False


def main():
    print("Ø±Ø¨Ø§Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯.")
    send_telegram_message(ADMIN_ID, "âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯.")

    update_id = None

    while True:
        check_sources()

        url = f"{telegram_api_url}/getUpdates"
        params = {"timeout": 10}
        if update_id:
            params["offset"] = update_id

        try:
            resp = requests.get(url, params=params)
            if resp.status_code == 200:
                updates = resp.json().get("result", [])
                for update in updates:
                    update_id = update["update_id"] + 1

                    # Ø§ÙˆÙ„ Ø¨Ø±Ø±Ø³ÛŒ callback query
                    if "callback_query" in update:
                        handle_callback_query(update)
                        continue

                    message = update.get("message", {})
                    text = message.get("text", "").strip()
                    chat_id = message.get("chat", {}).get("id")
                    username = message.get("from", {}).get("username", None)

                    if not chat_id or not text:
                        continue

                    # Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† ÙØ¹Ø§Ù„ÛŒØª
                    if str(chat_id) not in users:
                        add_user(chat_id, username)
                    else:
                        update_user_activity(chat_id)

                    log_message(chat_id, username, text)

                    # Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø­Ø§Ù„Øª Ø®Ø§Øµ Ø§Ø³ØªØŒ Ù…ØªÙ† Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
                    if process_admin_text(chat_id, text):
                        continue

                    # Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¹Ù…ÙˆÙ„
                    if text == "/start" or text.lower() == "Ø§Ù„Ùˆ":
                        send_subscription_links(chat_id)
                    elif text == "/updates" or text == "ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù†Ø§Ø¨Ø¹":
                        handle_updates_command(chat_id)
                    elif text == "/adminpanel":
                        if str(chat_id) == ADMIN_ID:
                            send_telegram_message(
                                chat_id,
                                "ğŸ› Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:",
                                reply_markup=admin_panel_keyboard())
                        else:
                            send_telegram_message(
                                chat_id, "â›”ï¸ Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
                    elif text == "ğŸ—‚ Ù…Ù†Ø§Ø¨Ø¹ ÙØ¹Ù„ÛŒ":
                        send_subscription_links(chat_id)
                    else:
                        # Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø®Ø§ØµÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯
                        pass

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª: {e}")

        time.sleep(2)


if __name__ == "__main__":
    main()


123
